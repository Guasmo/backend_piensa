// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enum para roles de usuario
enum Role {
  ADMIN
  USER
  SUPERADMIN
}

// Enum para estados de sesión
enum SessionStatus {
  ACTIVE
  COMPLETED
  INTERRUPTED
}

model Speaker {
  id                 Int      @id @default(autoincrement())
  name               String
  position           String
  state              Boolean  @default(false) // true = encendido, false = apagado
  batteryPercentage  Decimal  @db.Decimal(5, 2) // Porcentaje actual de batería (0.00-100.00)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relaciones
  usageSessions      UsageSession[]
  histories          History[]
  userspeakers       Userspeaker[]

  @@map("speakers")
}

model User {
  id        Int      @id @default(autoincrement())
  username  String
  email     String   @unique
  password  String
  role      Role     @default(USER)
  createdAt DateTime @default(now())

  // Relaciones
  usageSessions UsageSession[]
  histories     History[]
  userspeakers  Userspeaker[]

  @@map("users")
}

// Tabla para registrar sesiones de uso (cuando se enciende/apaga un parlante)
model UsageSession {
  id                        Int           @id @default(autoincrement())
  speakerId                 Int
  userId                    Int
  startTime                 DateTime      @default(now())
  endTime                   DateTime?     // NULL mientras esté en uso
  initialBatteryPercentage  Decimal?      @db.Decimal(5, 2) // Batería al iniciar sesión
  finalBatteryPercentage    Decimal?      @db.Decimal(5, 2) // Batería al terminar sesión
  speakerName               String?       // Nombre del parlante al momento de uso
  speakerPosition           String?       // Posición del parlante al momento de uso
  status                    SessionStatus @default(ACTIVE)

  // Relaciones
  speaker           Speaker             @relation(fields: [speakerId], references: [id])
  user              User                @relation(fields: [userId], references: [id])
  energyMeasurements EnergyMeasurement[]
  history           History?

  @@map("usage_sessions")
}

// ✅ CORRECCIÓN: Tabla actualizada para coincidir con los datos del ESP32
model EnergyMeasurement {
  id                      Int      @id @default(autoincrement())
  usageSessionId          Int
  
  // ✅ Campos que coinciden con el ESP32
  timestamp               Int      // Tiempo desde inicio en segundos
  current_mA              Decimal  @db.Decimal(10, 4) // Corriente en miliamperios
  voltage_V               Decimal  @db.Decimal(10, 4) // Voltaje en voltios
  power_mW                Decimal  @db.Decimal(10, 4) // Potencia en milivatios
  battery_remaining_percent Decimal @db.Decimal(5, 2) // Porcentaje de batería restante
  speaker_id              Int      // ID del parlante
  total_consumed_mAh      Decimal  @db.Decimal(10, 4) // Total consumido en mAh
  sample_index            Int      // Índice de muestra
  
  recordedAt              DateTime @default(now())

  // Relaciones
  usageSession UsageSession @relation(fields: [usageSessionId], references: [id])

  @@map("energy_measurements")
}

// Tabla de historial (resumen final de cada sesión)
model History {
  id                        Int      @id @default(autoincrement())
  usageSessionId            Int      @unique
  speakerId                 Int
  speakerName               String
  speakerPosition           String
  userId                    Int
  startDate                 DateTime
  endDate                   DateTime
  durationMinutes           Int?     // Duración total en minutos

  // ✅ CORRECCIÓN: Campos actualizados para coincidir con mediciones reales
  avgCurrent_mA             Decimal  @db.Decimal(10, 4) // Promedio de corriente en mA
  avgVoltage_V              Decimal  @db.Decimal(10, 4) // Promedio de voltaje en V
  avgPower_mW               Decimal  @db.Decimal(10, 4) // Promedio de potencia en mW
  
  totalCurrent_mA           Decimal  @db.Decimal(10, 4) // Total de corriente consumida
  totalVoltage_V            Decimal  @db.Decimal(10, 4) // Total de voltaje usado
  totalPower_mW             Decimal  @db.Decimal(10, 4) // Total de potencia consumida
  totalConsumed_mAh         Decimal  @db.Decimal(10, 4) // Total consumido en mAh

  // Información de batería
  initialBatteryPercentage  Decimal  @db.Decimal(5, 2)
  finalBatteryPercentage    Decimal  @db.Decimal(5, 2)
  batteryConsumed           Decimal  @db.Decimal(5, 2) // Porcentaje de batería consumida

  createdAt                 DateTime @default(now())

  // Relaciones
  usageSession UsageSession @relation(fields: [usageSessionId], references: [id])
  speaker      Speaker      @relation(fields: [speakerId], references: [id])
  user         User         @relation(fields: [userId], references: [id])

  @@map("history")
}

model Userspeaker {
  id         Int      @id @default(autoincrement())
  userId     Int
  speakerId  Int
  assignedAt DateTime @default(now())

  // Relaciones
  user    User    @relation(fields: [userId], references: [id])
  speaker Speaker @relation(fields: [speakerId], references: [id])

  @@map("userspeakers")
}